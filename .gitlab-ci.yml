stages:
  - build

build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
    
variables:
  #More Information on Kaniko Caching: https://cloud.google.com/build/docs/kaniko-cache
  KANIKO_CACHE_ARGS: "--cache=true --cache-copy-layers=true --cache-ttl=24h"
  VERSIONLABELMETHOD: "OnlyIfThisCommitHasVersion" # options: "OnlyIfThisCommitHasVersion","LastVersionTagInGit"
#  IMAGE_LABELS: >
#    --label org.opencontainers.image.vendor=$CI_SERVER_URL/$GITLAB_USER_LOGIN
#    --label org.opencontainers.image.authors=$CI_SERVER_URL/$GITLAB_USER_LOGIN
#    --label org.opencontainers.image.revision=$CI_COMMIT_SHA
#    --label org.opencontainers.image.source=$CI_PROJECT_URL
#    --label org.opencontainers.image.documentation=$CI_PROJECT_URL
#    --label org.opencontainers.image.licenses=$CI_PROJECT_URL
#    --label org.opencontainers.image.url=$CI_PROJECT_URL
#    --label vcs-url=$CI_PROJECT_URL
#    --label com.gitlab.ci.user=$CI_SERVER_URL/$GITLAB_USER_LOGIN
#    --label com.gitlab.ci.email=$GITLAB_USER_EMAIL
#    --label com.gitlab.ci.tagorbranch=$CI_COMMIT_REF_NAME
#    --label com.gitlab.ci.pipelineurl=$CI_PIPELINE_URL
#    --label com.gitlab.ci.commiturl=$CI_PROJECT_URL/commit/$CI_COMMIT_SHA
#    --label com.gitlab.ci.cijoburl=$CI_JOB_URL
#    --label com.gitlab.ci.mrurl=$CI_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_ID

  script:
    - /kaniko/executor
      --context "./apps/app/"
      --dockerfile "./apps/app/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"
      --cache=true